# CodeMirror Editor Refactoring Plan

This document outlines the plan to refactor the CodeMirror proof-of-concept into a production-ready feature, fully integrated with the application's existing state management and component architecture.

### Analysis of Current Implementation

The current implementation was a rapid proof-of-concept to get CodeMirror and Harper working together. While functional, it has several "rough edges" and deviates from our established patterns.

1.  **State Management is Isolated:** The `CodeMirrorPoc` component uses its own local `useState` for the document content. This is disconnected from our central `documentStore` (Zustand), which means changes aren't persisted and don't benefit from our existing autosave logic.
2.  **Suggestion Handling is Duplicated:**
    *   A new, temporary `HarperSuggestion` type was created. We should be using our standard suggestion types (e.g., `SpellingSuggestion`, `GrammarSuggestion`) and the central `suggestionStore`.
    *   A new, simplified `HarperSuggestionPopover` was created. We should be reusing the main `SuggestionPopover` component, which can render different popover UIs based on the suggestion type.
    *   The logic for showing/hiding the popover lives inside the `CodeMirrorPoc` component, duplicating logic that exists for the Tiptap editor.
3.  **Popover Positioning is Fragile:** The popover's position is calculated with a rough estimate. This is not accurate and will break with different font sizes or line wrapping. CodeMirror provides precise methods (`coordsAtPos`) to get screen coordinates, which we should be using with `floating-ui`.
4.  **Linter Hook Can Be Better Integrated:** The `useHarperLinter` hook is a good start, but it's a self-contained system. It should act as a bridge between the Harper engine and our application's state (the `suggestionStore`). Its primary job should be to run the linter and dispatch actions to the store.

### Refactoring Plan

The goal is to refactor the `CodeMirrorEditor` to be a "smart" component that seamlessly integrates with our existing stores and components, just like the current Tiptap editor does. Here is the proposed plan to achieve this.

| Priority | Task Description                               | Implementation Details                                                                                                                                                                                                                                                                                                                          | Code Pointers                                                                                                                                                                    |
| :---     | :---                                           | :---                                                                                                                                                                                                                                                                                                                                            | :---                                                                                                                                                                             |
| **P1**   | **Integrate Linter with Suggestion Store**     | Modify the `useHarperLinter` hook. Instead of returning suggestions, its `lint` function will convert raw Harper `Lint` objects into our app's standard `SpellingSuggestion` type and call an action to update the global `suggestionStore`. This is the most critical step to connect the new editor to our existing architecture. | • **Edit:** `src/hooks/useHarperLinter.ts`<br/>• **Use:** `src/store/suggestion/suggestion.store.ts`<br/>• **Use:** `src/types/index.ts`                                    |
| **P1**   | **Drive Decorations from the Store**           | The `CodeMirrorEditor`'s decoration logic will be refactored. It will no longer manage suggestions internally. Instead, it will receive the list of `spellingSuggestions` as a prop from the `suggestionStore` and use that data to render the wavy underlines. This fully decouples the editor view from the linting logic.                 | • **Edit:** `src/components/editor/CodeMirrorEditor.tsx`                                                                                                                         |
| **P2**   | **Integrate Popover with `floating-ui`**       | Remove the temporary `HarperSuggestionPopover`. The parent component (`DocumentEditor`) will be responsible for rendering the main `SuggestionPopover`. Use CodeMirror's `view.coordsAtPos(pos)` method to create a virtual element for `floating-ui`, ensuring the popover is positioned precisely over the highlighted text. | • **Edit:** `src/components/DocumentEditor.tsx`<br/>• **Delete:** `src/components/editor/HarperSuggestionPopover.tsx`<br/>• **Use:** `src/components/editor/SuggestionPopover.tsx` |
| **P2**   | **Use Transactional Updates for Changes**      | When a user accepts a suggestion, use `view.dispatch({ changes: { from, to, insert } })` to apply the change. This is the correct, transactional way to update CodeMirror's state, which is far more robust than manipulating the document as a string in React state.                                                    | • **Edit:** `src/components/DocumentEditor.tsx`<br/>• **Edit:** `src/components/editor/CodeMirrorEditor.tsx`                                                                   |
| **P3**   | **Integrate with Document Store & Autosave**   | The editor's content will be sourced from the `documentStore`. The `CodeMirrorEditor`'s `onChange` callback will be wired into our existing `useAutoSave` hook, making all document changes persistent and reliable.                                                                          | • **Edit:** `src/components/DocumentEditor.tsx`<br/>• **Edit:** `src/components/editor/CodeMirrorEditor.tsx`<br/>• **Use:** `src/hooks/useAutoSave.ts`                          |
| **P3**   | **Final Cleanup and Replacement**              | Once fully integrated, replace the old Tiptap `<TextEditor>` in `DocumentEditor.tsx` with our new `<CodeMirrorEditor>`. Finally, delete all temporary POC files, including `CodeMirrorPoc.tsx`, `HarperPoc.tsx`, and the now-redundant `harper.d.ts` types.                           | • **Edit:** `src/components/DocumentEditor.tsx`<br/>• **Delete:** `src/components/TextEditor.tsx`<br/>• **Delete:** `src/components/CodeMirrorPoc.tsx`                            |

</rewritten_file> 